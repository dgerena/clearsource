var csv = require('csv');

module.exports.readCsv = function (filepath, cb) {

	csv()
		.from.path(filepath, { delimiter: ',', escape: '"' })
		.to.array(function(data) {
			var header = data.shift();
			
			// clean header data: make all lowercase. remove newlines. remove duplicate spaces
			for (var i = 0; i < header.length; i++) {
				header[i] = header[i].toLowerCase().replace(/\n/g, ' ').replace(/\r/g, ' ').replace(/\s+/g, ' ').trim();
			}
			
			// Label the remaining data with values from the header row
			// loop through data and apply header labels to data
			var labelledRows = [];
			for (var r = 0; r < data.length; r++) {
				var row = data[r];
				var labelledRow = {};
				for (var c = 0; c < row.length; c++) {
					labelledRow[header[c]] = row[c];
				};
				labelledRows.push(labelledRow);
			};
			
			cb(null, labelledRows);
		})
		.on('error', function(error){
			cb(error);
		});
	
};